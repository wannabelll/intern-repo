pipeline {
    agent any

    environment {
        GIT_TAG = ''
        GITHUB_TOKEN = credentials('jenkins-github-integration-demo.2025-03-06.private-key.pem')
        REPO_URL = 'https://github.com/your-username/your-repository.git'
        ZIP_NAME = ''
    }

tools{
go '1.24.0'
}

    stages {
        stage('Checkout') {
            steps {
                script {
                    // Explicitly fetch tags before using them
                    sh 'git fetch --tags'
                }
            }
        }

        stage('Get Git Tag') {
            steps {
                script {
                    // Attempt to get the latest Git tag, or fallback to commit hash if no tags exist
                    GIT_TAG = sh(script: "git describe --tags --abbrev=0 || git rev-parse --short HEAD", returnStdout: true).trim()
                    echo "Using tag: ${GIT_TAG}"
                }
            }
        }

        stage('Go Build') {
            steps {
                script {
                    // Build the Go binary with flags to reduce its size
                    sh 'go build -ldflags="-s -w" -o gitea'
                }
            }
        }

        stage('Create TAR Archive') {
            steps {
                script {
                    // Define the files to include in the archive
                    def filesToInclude = [
                        "web_src/",   
                        "templates/", 
                        "models/", 
                        "public/", 
                        "options/", 
                        "node_modules/", 
                        "modules/", 
                        "gitea",  // The built Go binary
                        "custom/"     
                    ]

                    // Build the tar command dynamically, using -C to avoid absolute paths
                    def tarCommand = "tar -czf gitea-archive-${GIT_TAG}.tar.gz -C $WORKSPACE "
                    filesToInclude.each { file -> 
                        tarCommand += "${file} "
                    }

                    // Run the tar command
                    sh tarCommand
                }
            }
        }

        stage('Create GitHub Release') {
            when { branch 'main' }
            steps {
                script {
                    echo 'Checking if GitHub Release already exists...'

                    // Check if the release already exists using GitHub CLI
                    def releaseExists = sh(
                        script: "gh release view ${GIT_TAG} --repo ${REPO_URL} > /dev/null 2>&1",
                        returnStatus: true
                    ) == 0

                    if (releaseExists) {
                        echo "Release ${GIT_TAG} already exists. Skipping release creation."
                    } else {
                        echo 'Creating GitHub Release...'
                        
                        // Create the GitHub release and upload the tar.gz file
                        sh """
                        gh release create \
                            ${GIT_TAG} \
                            gitea-archive-${GIT_TAG}.tar.gz \
                            --repo ${REPO_URL} \
                            --generate-notes
                        """
                    }
                }
            }
        }
    }
}
